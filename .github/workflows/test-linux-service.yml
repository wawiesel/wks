name: Test Linux Service Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-linux-service:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image with systemd
        run: |
          docker build \
            -f Dockerfile.test-linux-service \
            -t wks-test-linux-service:latest \
            .

      - name: Run Linux service integration test
        run: |
          # Run container with systemd support
          # Use --init to run systemd as PID 1 (required for systemd to work)
          # --privileged is required for systemd to work properly
          # --tmpfs /run and --tmpfs /tmp are needed for systemd
          # --volume /sys/fs/cgroup is required for systemd
          docker run \
            --rm \
            --init \
            --privileged \
            --tmpfs /run \
            --tmpfs /tmp \
            --volume /sys/fs/cgroup:/sys/fs/cgroup:ro \
            --volume "${{ github.workspace }}:/workspace:rw" \
            --workdir /workspace \
            -e WKS_HOME=/home/testuser/.wks \
            wks-test-linux-service:latest \
            /bin/bash -c "
              # Wait for systemd to be ready (it's PID 1 with --init)
              sleep 5

              # Verify systemd is running
              systemctl status || true

              # Enable lingering for testuser (required for user services)
              # This allows user services to run without an active login session
              sudo -u testuser loginctl enable-linger testuser || true

              # Start user systemd session for testuser
              # This is required for systemctl --user to work
              sudo -u testuser systemctl --user daemon-reload || true

              # Switch to testuser and set up environment
              sudo -u testuser bash -c '
                export WKS_HOME=/home/testuser/.wks
                export PATH=/home/testuser/.local/bin:\$PATH
                export XDG_RUNTIME_DIR=/run/user/\$(id -u)
                cd /workspace

                # Make workspace writable for testuser
                sudo chown -R testuser:testuser /workspace

                # Install package
                pip3 install --user -e .

                # Verify systemd user session is working
                systemctl --user list-units --no-pager || true

                # Run the integration test
                python3 -m pytest tests/integration/test_linux_service_install.py -v -m linux_service
              '
            "
