name: Test Linux Service Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-linux-service:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image with systemd
        run: |
          docker build \
            -f Dockerfile.test-linux-service \
            -t wks-test-linux-service:latest \
            .

      - name: Run Linux service integration test
        run: |
          set -x  # Enable debug output

          # First, debug the image - run bash to check what's inside
          echo "=== Debug: checking image contents ==="
          docker run --rm wks-test-linux-service:latest ls -la /lib/systemd/ || true
          docker run --rm wks-test-linux-service:latest ls -la /usr/lib/systemd/ || true
          docker run --rm wks-test-linux-service:latest which systemd || true
          docker run --rm wks-test-linux-service:latest file /lib/systemd/systemd || true
          docker run --rm wks-test-linux-service:latest file /usr/lib/systemd/systemd || true
          docker run --rm wks-test-linux-service:latest /lib/systemd/systemd --help || true
          docker run --rm wks-test-linux-service:latest /usr/lib/systemd/systemd --help || true
          docker run --rm wks-test-linux-service:latest cat /etc/os-release || true

          # Check cgroups on host
          echo "=== Debug: host cgroups ==="
          ls -la /sys/fs/cgroup/ || true
          cat /proc/self/cgroup || true

          # Try running systemd with strace or verbose output
          echo "=== Testing systemd invocation ==="
          docker run --rm wks-test-linux-service:latest /usr/bin/systemd --help || echo "systemd --help failed with code $?"

          echo "=== Testing container startup ==="
          timeout 30 docker run --rm \
            --privileged \
            --volume /sys/fs/cgroup:/sys/fs/cgroup:rw \
            wks-test-linux-service:latest || echo "Container exited (expected with timeout)"

          echo "=== Starting container in background ==="
          CONTAINER_ID=$(docker run -d \
            --privileged \
            --volume /sys/fs/cgroup:/sys/fs/cgroup:rw \
            --volume "${{ github.workspace }}:/workspace:rw" \
            --workdir /workspace \
            -e WKS_HOME=/home/testuser/.wks \
            wks-test-linux-service:latest)

          echo "Container ID: $CONTAINER_ID"

          # Poll for container status
          for i in {1..20}; do
            echo "=== Check $i: Container status ==="
            docker ps -a | grep $CONTAINER_ID || true

            if docker ps | grep -q $CONTAINER_ID; then
              echo "Container is running"
              docker logs $CONTAINER_ID 2>&1 | tail -50 || true
              break
            else
              echo "Container not running yet, checking logs..."
              docker logs $CONTAINER_ID 2>&1 || true

              # Check if it exited
              STATUS=$(docker inspect -f '{{.State.Status}}' $CONTAINER_ID 2>/dev/null || echo "unknown")
              echo "Container status: $STATUS"

              if [ "$STATUS" = "exited" ]; then
                echo "Container exited. Exit code:"
                docker inspect -f '{{.State.ExitCode}}' $CONTAINER_ID || true
                echo "Full logs:"
                docker logs $CONTAINER_ID 2>&1 || true
                exit 1
              fi
            fi
            sleep 2
          done

          # Final check
          if ! docker ps | grep -q $CONTAINER_ID; then
            echo "Container failed to stay running"
            docker logs $CONTAINER_ID 2>&1 || true
            exit 1
          fi

          # Verify systemd is actually running
          echo "Checking systemd status..."
          docker exec $CONTAINER_ID systemctl is-system-running || echo "systemd check failed"

          # Enable lingering for testuser (required for user services)
          docker exec $CONTAINER_ID sudo -u testuser loginctl enable-linger testuser || true

          # Wait for user systemd session to be ready
          echo "Waiting for user systemd session..."
          for i in {1..30}; do
            if docker exec $CONTAINER_ID sudo -u testuser systemctl --user list-units --no-pager >/dev/null 2>&1; then
              echo "User systemd session is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Warning: User systemd session may not be ready"
            fi
            sleep 1
          done

          # Run the test inside the container
          docker exec $CONTAINER_ID sudo -u testuser bash -c '
            set -e
            export WKS_HOME=/home/testuser/.wks
            export PATH=/home/testuser/.local/bin:$PATH
            USER_ID=$(id -u)
            export XDG_RUNTIME_DIR=/run/user/$USER_ID
            mkdir -p "$XDG_RUNTIME_DIR" || true
            cd /workspace
            sudo chown -R testuser:testuser /workspace || true
            echo "Upgrading pip..."
            python3 -m pip install --user --upgrade pip
            echo "Installing package..."
            pip3 install --user -e .
            echo "Running tests..."
            python3 -m pytest tests/integration/test_linux_service_install.py -v -m linux_service
          ' 2>&1
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Test failed with exit code $EXIT_CODE"
            echo "Container logs:"
            docker logs $CONTAINER_ID 2>&1 | tail -100 || true
            echo "Checking container status..."
            docker ps -a | grep $CONTAINER_ID || true
          fi

          # Cleanup
          docker stop $CONTAINER_ID || true
          docker rm $CONTAINER_ID || true
          exit $EXIT_CODE
