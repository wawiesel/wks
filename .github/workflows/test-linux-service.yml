name: Test Linux Service Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-linux-service:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3


      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase repo name
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Pull test image
        run: |
          docker pull ghcr.io/${{ env.REPO }}/test-linux-service:latest
          docker tag ghcr.io/${{ env.REPO }}/test-linux-service:latest wks-test-linux-service:latest

      - name: Run Linux service integration test
        run: |
          # Run container with systemd support
          # Key: --tmpfs /run and /run/lock are required for systemd user sessions
          CONTAINER_ID=$(docker run -d \
            --privileged \
            --cgroupns=host \
            --tmpfs /run --tmpfs /run/lock \
            --volume=/sys/fs/cgroup:/sys/fs/cgroup:rw \
            --volume "${{ github.workspace }}:/workspace:rw" \
            --workdir /workspace \
            -e WKS_HOME=/home/testuser/.wks \
            wks-test-linux-service:latest)

          echo "Container ID: $CONTAINER_ID"

          # Wait for systemd to boot
          echo "Waiting for systemd to initialize..."
          sleep 10

          # Check if container is running
          CONTAINER_STATUS=$(docker inspect -f '{{.State.Running}}' $CONTAINER_ID 2>/dev/null || echo "false")
          if [ "$CONTAINER_STATUS" != "true" ]; then
            echo "Container stopped unexpectedly. Logs:"
            docker logs $CONTAINER_ID 2>&1 || true
            echo "Inspect:"
            docker inspect $CONTAINER_ID | head -50 || true
            exit 1
          fi
          echo "Container is running"

          # Verify systemd is running
          echo "Checking systemd status..."
          docker exec $CONTAINER_ID systemctl is-system-running --wait || docker exec $CONTAINER_ID systemctl status || true

          # Get the testuser UID
          TEST_USER_UID=$(docker exec $CONTAINER_ID id -u testuser)
          echo "Test user UID: $TEST_USER_UID"

          # Enable lingering for testuser (starts systemd --user at boot)
          echo "Enabling linger..."
          docker exec $CONTAINER_ID loginctl enable-linger testuser || true

          # Wait for user systemd session to be ready
          echo "Waiting for user systemd session..."
          for i in {1..30}; do
            if docker exec $CONTAINER_ID sudo -u testuser bash -c "export XDG_RUNTIME_DIR=/run/user/$TEST_USER_UID && systemctl --user list-units --no-pager" >/dev/null 2>&1; then
              echo "User systemd session is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Warning: User systemd session may not be ready after 30 seconds"
              docker exec $CONTAINER_ID ls -la /run/user/ || true
              docker exec $CONTAINER_ID systemctl status user@$TEST_USER_UID.service || true
            fi
            sleep 1
          done

          # Run the test inside the container
          # Key: Set XDG_RUNTIME_DIR and DBUS_SESSION_BUS_ADDRESS explicitly
          # Do NOT use dbus-run-session - we want to use the existing systemd user bus
          docker exec $CONTAINER_ID sudo -u testuser bash -c "
            set -e
            export WKS_HOME=/home/testuser/.wks
            export PATH=/home/testuser/.local/bin:\$PATH

            # Point to the existing systemd user socket
            export XDG_RUNTIME_DIR=/run/user/$TEST_USER_UID
            export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$TEST_USER_UID/bus

            # Debug: Verify connection
            echo '=== Debug: systemd user check ==='
            systemctl --user is-active dbus.service || echo 'dbus.service not active'
            systemctl --user list-units --no-pager | head -10 || echo 'list-units failed'

            cd /workspace
            sudo chown -R testuser:testuser /workspace || true
            echo 'Upgrading pip...'
            python3 -m pip install --user --upgrade pip --break-system-packages
            echo 'Installing package...'
            pip3 install --user -e . --break-system-packages
            echo 'Running tests...'
            python3 -m pytest tests/integration/test_linux_service_install.py -v -s -m linux_service
          " 2>&1
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Test failed with exit code $EXIT_CODE"
            echo "Container logs:"
            docker logs $CONTAINER_ID 2>&1 | tail -100 || true
          fi

          # Cleanup
          docker stop $CONTAINER_ID || true
          docker rm $CONTAINER_ID || true
          exit $EXIT_CODE
