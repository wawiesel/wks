name: Test Linux Service Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-linux-service:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image with systemd
        run: |
          docker build \
            -f Dockerfile.test-linux-service \
            -t wks-test-linux-service:latest \
            .

      - name: Run Linux service integration test
        run: |
          # Run container with systemd support
          # Systemd runs as PID 1 via ENTRYPOINT in Dockerfile
          # --privileged is required for systemd to work properly
          # --tmpfs /run and --tmpfs /tmp are needed for systemd
          # --volume /sys/fs/cgroup is required for systemd
          CONTAINER_ID=$(docker run -d \
            --privileged \
            --tmpfs /run \
            --tmpfs /tmp \
            --volume /sys/fs/cgroup:/sys/fs/cgroup:ro \
            --volume "${{ github.workspace }}:/workspace:rw" \
            --workdir /workspace \
            -e WKS_HOME=/home/testuser/.wks \
            wks-test-linux-service:latest)

          # Wait for systemd to be ready and verify container is running
          sleep 10

          # Check if container is still running
          if ! docker ps | grep -q $CONTAINER_ID; then
            echo "Container stopped unexpectedly. Logs:"
            docker logs $CONTAINER_ID 2>&1 || true
            echo "Container status:"
            docker ps -a | grep $CONTAINER_ID || true
            exit 1
          fi

          # Verify systemd is actually running
          echo "Checking systemd status..."
          docker exec $CONTAINER_ID systemctl is-system-running || echo "systemd check failed"

          # Enable lingering for testuser (required for user services)
          docker exec $CONTAINER_ID sudo -u testuser loginctl enable-linger testuser || true

          # Wait a bit more for user session to be ready
          sleep 5

          # Run the test inside the container
          docker exec $CONTAINER_ID sudo -u testuser bash -c '
            export WKS_HOME=/home/testuser/.wks
            export PATH=/home/testuser/.local/bin:$PATH
            export XDG_RUNTIME_DIR=/run/user/$(id -u)
            cd /workspace
            sudo chown -R testuser:testuser /workspace
            pip3 install --user -e .
            python3 -m pytest tests/integration/test_linux_service_install.py -v -m linux_service
          ' || EXIT_CODE=$?

          # Cleanup
          docker stop $CONTAINER_ID || true
          docker rm $CONTAINER_ID || true
          exit ${EXIT_CODE:-0}
