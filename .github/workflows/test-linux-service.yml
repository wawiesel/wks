name: Test Linux Service Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-linux-service:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image with systemd
        run: |
          docker build \
            -f Dockerfile.test-linux-service \
            -t wks-test-linux-service:latest \
            .

      - name: Run Linux service integration test
        run: |
          # Run container with systemd support
          # Based on geerlingguy's proven approach:
          # https://github.com/geerlingguy/docker-ubuntu2404-ansible
          CONTAINER_ID=$(docker run -d \
            --privileged \
            --cgroupns=host \
            --volume=/sys/fs/cgroup:/sys/fs/cgroup:rw \
            --volume "${{ github.workspace }}:/workspace:rw" \
            --workdir /workspace \
            -e WKS_HOME=/home/testuser/.wks \
            wks-test-linux-service:latest)

          echo "Container ID: $CONTAINER_ID"

          # Wait for systemd to boot
          echo "Waiting for systemd to initialize..."
          sleep 10

          # Check if container is running
          CONTAINER_STATUS=$(docker inspect -f '{{.State.Running}}' $CONTAINER_ID 2>/dev/null || echo "false")
          if [ "$CONTAINER_STATUS" != "true" ]; then
            echo "Container stopped unexpectedly. Logs:"
            docker logs $CONTAINER_ID 2>&1 || true
            echo "Inspect:"
            docker inspect $CONTAINER_ID | head -50 || true
            exit 1
          fi
          echo "Container is running"

          # Verify systemd is running
          echo "Checking systemd status..."
          docker exec $CONTAINER_ID systemctl is-system-running --wait || docker exec $CONTAINER_ID systemctl status || true

          # Set up XDG_RUNTIME_DIR for testuser
          echo "Setting up user runtime directory..."
          docker exec $CONTAINER_ID bash -c '
            USER_ID=$(id -u testuser)
            mkdir -p /run/user/$USER_ID
            chown testuser:testuser /run/user/$USER_ID
            chmod 700 /run/user/$USER_ID
          '

          # Enable lingering for testuser (required for user services)
          echo "Enabling linger..."
          docker exec $CONTAINER_ID loginctl enable-linger testuser || true

          # Wait a bit for systemd-logind to process the linger
          sleep 3

          # Check if user service is now running
          echo "Checking if user@testuser.service is active..."
          docker exec $CONTAINER_ID systemctl status user@$(docker exec $CONTAINER_ID id -u testuser).service || true

          # If not active, start it explicitly
          docker exec $CONTAINER_ID systemctl start user@$(docker exec $CONTAINER_ID id -u testuser).service || true

          # Wait for user systemd session to be ready
          echo "Waiting for user systemd session..."
          for i in {1..30}; do
            if docker exec $CONTAINER_ID sudo -u testuser bash -c 'export XDG_RUNTIME_DIR=/run/user/$(id -u) && systemctl --user list-units --no-pager' >/dev/null 2>&1; then
              echo "User systemd session is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Warning: User systemd session may not be ready"
              # Show debug info
              docker exec $CONTAINER_ID ls -la /run/user/ || true
              docker exec $CONTAINER_ID cat /run/user/$(docker exec $CONTAINER_ID id -u testuser)/bus 2>&1 || true
            fi
            sleep 1
          done

          # Run the test inside the container using dbus-run-session
          # This provides a D-Bus session for systemctl --user without needing cgroup delegation
          docker exec $CONTAINER_ID sudo -u testuser bash -c '
            set -e
            export WKS_HOME=/home/testuser/.wks
            export PATH=/home/testuser/.local/bin:$PATH
            export XDG_RUNTIME_DIR=/run/user/$(id -u)

            # Debug: Check systemd status
            echo "=== Debug: systemd check ==="
            systemctl --version || echo "systemctl not found"
            cat /proc/1/comm || echo "cant read /proc/1/comm"

            # Check user bus socket
            echo "Checking for user bus..."
            ls -la /run/user/$(id -u)/ 2>&1 || echo "No user runtime dir"

            # Try running systemctl --user with dbus-run-session
            echo "Testing systemctl --user with dbus-run-session..."
            dbus-run-session -- systemctl --user list-units --no-pager 2>&1 || echo "dbus-run-session approach also failed"

            cd /workspace
            sudo chown -R testuser:testuser /workspace || true
            echo "Upgrading pip..."
            python3 -m pip install --user --upgrade pip --break-system-packages
            echo "Installing package..."
            pip3 install --user -e . --break-system-packages
            echo "Running tests..."
            # Run with dbus-run-session wrapper for the whole test
            dbus-run-session -- python3 -m pytest tests/integration/test_linux_service_install.py -v -m linux_service
          ' 2>&1
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Test failed with exit code $EXIT_CODE"
            echo "Container logs:"
            docker logs $CONTAINER_ID 2>&1 | tail -100 || true
          fi

          # Cleanup
          docker stop $CONTAINER_ID || true
          docker rm $CONTAINER_ID || true
          exit $EXIT_CODE
