name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Stage 1: Smoke tests - ultra-fast using pre-built Docker image
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4


      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run smoke tests in Docker
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          export IMAGE_NAME="ghcr.io/${REPO_LOWER}/ci-runner:v1"
          ./scripts/docker_shell.sh docker "python3 -m venv .venv --system-site-packages && source .venv/bin/activate && pip install . --no-cache-dir && python -m pytest tests/smoke/ -v --tb=short"

  # Stage 2a: Code Quality - runs in parallel with Docker Tests
  quality:
    name: Code Quality
    needs: smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip --no-cache-dir
          pip install ruff mypy --no-cache-dir

      - name: Run Ruff (format + lint)
        run: |
          ruff format --check .
          ruff check .

      - name: Run Mypy
        run: |
          pip install -e . --quiet --no-cache-dir
          mypy wks/ --ignore-missing-imports

  # Stage 2b: Docker deep tests - comprehensive testing with stats generation
  docker-tests:
    name: Docker Deep Tests
    needs: smoke
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref || github.ref }}
          submodules: recursive
      - name: Free Disk Space (Ubuntu)
        run: ./scripts/ci_cleanup_disk.sh

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull test image
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker pull ghcr.io/${REPO_LOWER}/ci-runner:v1
          ./scripts/disk_avail.sh "After image pull"

      - name: Run tests in Docker
        id: docker-tests
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          # Run container in background with systemd as init (PID 1)
          CONTAINER_ID=$(docker run -d \
            --privileged \
            --cgroupns=host \
            --tmpfs /run \
            --tmpfs /run/lock \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e GITHUB_ACTIONS=true \
            ghcr.io/${REPO_LOWER}/ci-runner:v1 \
            /lib/systemd/systemd)

          # Wait for systemd to settle (now bootstraps user session automatically)
          sleep 5

          # Install package as testuser
          docker exec -u testuser "$CONTAINER_ID" pip3 install --user -e . --no-cache-dir --break-system-packages

          # Run full test suite with coverage
          docker exec -u testuser "$CONTAINER_ID" python3 -m pytest --cov=wks --cov-report=xml tests/ -v --tb=short
          TEST_RESULT=$?

          # Run mutation tests for each domain found in wks/api
          docker exec -u testuser "$CONTAINER_ID" /bin/bash -c '
            for dir in wks/api/*/; do
              domain=$(basename "$dir")
              if [ "$domain" != "__pycache__" ]; then
                python3 scripts/test_mutation_api.py "$domain" --log-interval 15 || true
              fi
            done
          '

          # Run Linux service installation test (now has systemd)
          docker exec -u testuser "$CONTAINER_ID" python3 -m pytest tests/integration/test_linux_service_install.py -v --tb=short || true

          # Generate all statistics using the same script as local development
          # This ensures CI and local are guaranteed to be the same (DRY)
          docker exec -u testuser "$CONTAINER_ID" python3 scripts/generate_all_stats.py --skip-tests --skip-mutations || true

          ./scripts/disk_avail.sh "After tests"

          # Cleanup
          docker rm -f "$CONTAINER_ID"

          if [ $TEST_RESULT -ne 0 ]; then
            exit $TEST_RESULT
          fi
          echo "passed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload coverage and mutation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage.xml
            qa/metrics/*.json
            mutants/mutmut-stats.json
          retention-days: 30

      - name: Check test result
        id: test-check
        run: |
          if [ "${{ steps.docker-tests.outputs.passed }}" == "true" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate traceability audit report
        if: steps.docker-tests.outputs.passed == 'true'
        run: |
           pip install pyyaml
           python3 scripts/update_traceability_audit.py

      - name: Regenerate stats (for verification or update)
        if: steps.docker-tests.outputs.passed == 'true'
        run: |
           pip install tabulate
           python3 scripts/update_readme_stats.py

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain qa/metrics README.md qa/traceability_audit.html)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "::notice::Statistics have been updated by CI"
            echo "::group::Statistics diff"
            git diff qa/metrics README.md qa/traceability_audit.html
            echo "::endgroup::"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated statistics
        if: steps.check-changes.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update stats and traceability [skip ci]"
          file_pattern: "qa/metrics/*.json README.md qa/traceability_audit.html"
          skip_dirty_check: true
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      - name: Fail if tests failed
        if: steps.test-check.outputs.all_passed != 'true'
        run: exit 1

  # Stage 3: Python version compatibility - parallel testing on multiple versions
  compatibility:
    name: Python ${{ matrix.python-version }}
    needs: docker-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12', '3.13', '3.14']
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        run: |
          chmod +x scripts/ci_cleanup_disk.sh
          ./scripts/ci_cleanup_disk.sh

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'setup.py') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run tests
        env:
          WKS_TEST_MONGO_URI: mongodb://127.0.0.1:27017
        run: |
          python -m pytest tests/ -v --tb=short -n auto --ignore=tests/integration/test_linux_service_install.py

      - name: Check imports
        run: |
          python -c "import wks; print('âœ“ Package imports successfully')"
