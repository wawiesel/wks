name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Stage 1: Smoke tests - ultra-fast using pre-built Docker image
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run smoke tests in Docker
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/${REPO_LOWER}/ci-runner:v1 \
            bash -c "pip3 install -e . --break-system-packages && python3 -m pytest tests/smoke/ -v --tb=short"

  # Stage 2a: Code Quality - runs in parallel with Docker Tests
  quality:
    name: Code Quality
    needs: smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff (format + lint)
        run: |
          ruff format --check .
          ruff check .

      - name: Run Mypy
        run: |
          pip install -e . --quiet
          mypy wks/ --ignore-missing-imports

  # Stage 2b: Docker deep tests - comprehensive testing with stats generation
  docker-tests:
    name: Docker Deep Tests
    needs: smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref || github.ref }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull test image
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker pull ghcr.io/${REPO_LOWER}/ci-runner:v1

      - name: Run tests in Docker
        id: docker-tests
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker run --rm \
            --privileged \
            --cgroupns=host \
            --tmpfs /run \
            --tmpfs /run/lock \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e GITHUB_ACTIONS=true \
            ghcr.io/${REPO_LOWER}/ci-runner:v1 \
            bash -c "
              # Start systemd in background
              /lib/systemd/systemd --system &
              sleep 2

              # Install package as testuser (should be null-op if deps are in image)
              sudo -u testuser bash -c 'cd /workspace && pip3 install --user -e . --break-system-packages'

              # Run full test suite with coverage
              sudo -u testuser bash -c 'cd /workspace && python3 -m pytest --cov=wks --cov-report=xml tests/ -v --tb=short'
              TEST_RESULT=\$?

              # Run mutation tests
              sudo -u testuser bash -c 'cd /workspace && python3 scripts/test_mutation_api.py --max-children 2' || true

              # Run Linux service installation test
              sudo -u testuser bash -c 'cd /workspace && python3 -m pytest tests/integration/test_linux_service_install.py -v --tb=short' || true

              exit \$TEST_RESULT
            "
          echo "passed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check test result
        id: test-check
        run: |
          if [ "${{ steps.docker-tests.outcome }}" == "success" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate stats.json (always)
        run: |
          python3 -m pip install -e . --quiet
          python3 scripts/update_readme_stats.py --json-only

      - name: Update README (only if all tests passed)
        if: steps.test-check.outputs.all_passed == 'true'
        run: |
          python3 scripts/update_readme_stats.py --from-json

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain stats.json README.md)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git diff stats.json README.md
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated statistics
        if: steps.check-changes.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update statistics [skip ci]"
          file_pattern: "stats.json README.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      - name: Fail if tests failed
        if: steps.test-check.outputs.all_passed != 'true'
        run: exit 1

  # Stage 3: Python version compatibility - parallel testing on multiple versions
  compatibility:
    name: Python ${{ matrix.python-version }}
    needs: docker-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'setup.py') }}

      - name: Install MongoDB
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg ca-certificates
          sudo mkdir -p /usr/share/keyrings
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-org-server

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short -n auto --ignore=tests/integration/test_linux_service_install.py

      - name: Check imports
        run: |
          python -c "import wks; print('âœ“ Package imports successfully')"
