#!/bin/bash
# Manage a local mongod instance for WKS, storing data under ~/.wks/mongodb

set -e

DBROOT="$HOME/.wks/mongodb"
DBPATH="$DBROOT/db"
LOGFILE="$DBROOT/mongod.log"
PIDFILE="$DBROOT/mongod.pid"
PORT="27027"

ensure_dirs() {
  mkdir -p "$DBPATH"
  mkdir -p "$DBROOT"
}

is_running() {
  if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if ps -p "$PID" > /dev/null 2>&1; then
      return 0
    else
      return 1
    fi
  fi
  return 1
}

case "$1" in
  start)
    if is_running; then
      echo "mongod already running (PID $(cat "$PIDFILE"))"
      exit 0
    fi
    ensure_dirs
    if ! command -v mongod >/dev/null 2>&1; then
      echo "Error: mongod not found in PATH. Install MongoDB Community (e.g., via brew)"
      exit 1
    fi
    echo "Starting mongod on port $PORT with dbpath $DBPATH ..."
    mongod --dbpath "$DBPATH" --logpath "$LOGFILE" --fork --bind_ip 127.0.0.1 --port "$PORT"
    # Find PID from process list
    PID=$(pgrep -f "mongod .*--dbpath $DBPATH" | head -n1 || true)
    if [ -n "$PID" ]; then
      echo "$PID" > "$PIDFILE"
      echo "Started mongod (PID $PID). Log: $LOGFILE"
    else
      echo "Failed to determine mongod PID. Check log: $LOGFILE"
      exit 1
    fi
    ;;
  stop)
    if is_running; then
      PID=$(cat "$PIDFILE")
      echo "Stopping mongod (PID $PID) ..."
      kill "$PID" || true
      sleep 1
      if ps -p "$PID" >/dev/null 2>&1; then
        echo "mongod did not stop. Sending TERM..."
        kill -TERM "$PID" || true
      fi
      rm -f "$PIDFILE"
      echo "Stopped."
    else
      echo "mongod is not running"
    fi
    ;;
  status)
    if is_running; then
      echo "mongod running (PID $(cat "$PIDFILE")) on port $PORT with dbpath $DBPATH"
      exit 0
    else
      echo "mongod is not running"
      exit 1
    fi
    ;;
  log)
    ensure_dirs
    if [ -f "$LOGFILE" ]; then
      tail -f "$LOGFILE"
    else
      echo "No log at $LOGFILE"
      exit 1
    fi
    ;;
  *)
    echo "Usage: $0 {start|stop|status|log}"
    exit 1
    ;;
esac

